// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Define roles
enum Role {
  ADMIN
  PHARMACIST
  USER
}

model User {
  userId    String   @id @default(cuid()) @map("user_id")
  username  String   @db.VarChar(50)
  email     String   @unique @db.VarChar(100)
  password  String   @db.VarChar(100)
  role      Role     @default(USER)
  points    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
  chats  Chat[] 

  @@index([email])
  @@map("users")
}

model Medicine {
  medicineId       String   @id @default(cuid()) @map("medicine_id")
  medicineName     String   @map("medicine_name") @db.VarChar(50)
  medicineType     String   @map("medicine_type") @db.VarChar(50)
  medicineQuantity Int      @map("medicine_quantity")
  price            Decimal? @db.Decimal(10, 2)
  imageUrl         String?  @map("image_url") @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  orderItems OrderItem[]

  @@index([medicineName])
  @@index([medicineType])
  @@map("medicines")
}

model Order {
  orderId         String   @id @default(cuid()) @map("order_id")
  userId          String   @map("user_id")
  customerName    String   @map("customer_name") @db.VarChar(255)
  customerPhone   String   @map("customer_phone") @db.VarChar(50)
  customerAddress String?  @map("customer_address") @db.Text // Optional (for pickup)
  orderType       String   @map("order_type") @db.VarChar(20)
  useAi           Boolean  @default(false) @map("use_ai")
  totalPoints     Int      @default(0) @map("total_points")
  status          String   @default("pending") @db.VarChar(20)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user  User        @relation(fields: [userId], references: [userId], onDelete: Cascade)
  items OrderItem[] // This creates the relation to OrderItem

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  orderItemId String   @id @default(cuid()) @map("order_item_id")
  orderId     String   @map("order_id")
  medicineId  String   @map("medicine_id")
  quantity    Int
  price       Decimal  @db.Decimal(10, 2) // Snapshot the price at time of purchase

  // Relationships
  order    Order    @relation(fields: [orderId], references: [orderId], onDelete: Cascade)
  medicine Medicine @relation(fields: [medicineId], references: [medicineId], onDelete: Restrict)

  @@index([orderId])
  @@index([medicineId])
  @@map("order_items")
}

model Chat {
  id             Int      @id @default(autoincrement())
  userId         String?
  sessionData    Json
  recommendation String?
  summary        Json? // Your new summary field
  createdAt      DateTime @default(now())

  user User? @relation(fields: [userId], references: [userId], onDelete: SetNull)

  @@map("chats")
}