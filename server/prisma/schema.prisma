generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  userId    String   @id @default(cuid()) @map("user_id")
  username  String   @db.VarChar(50)
  email     String   @unique @db.VarChar(100)
  password  String   @db.VarChar(100)
  role      Role     @default(USER)
  points    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  branch               PharmacyBranch? @relation("BranchAccount")
  lastSelectedBranchId String?         @map("last_selected_branch_id")
  lastSelectedBranch   PharmacyBranch? @relation("UserLastBranch", fields: [lastSelectedBranchId], references: [branchId])
  chats     Chat[]
  orders    Order[]
  prescriptionsAsPharmacist Prescription[] @relation("PharmacistPrescriptions") 
  prescriptionsAsCustomer   Prescription[] @relation("CustomerPrescriptions")
  @@index([email])
  @@index([lastSelectedBranchId])
  @@map("users")
}

model PharmacyBranch {
  branchId  String   @id @default(cuid()) @map("branch_id")
  name      String   @db.VarChar(100)
  address   String   @db.VarChar(255)
  phone     String?  @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String @unique @map("user_id")
  user      User   @relation("BranchAccount", fields: [userId], references: [userId])
  chats Chat[]
  orders Order[]
  selectedByUsers User[] @relation("UserLastBranch")

  @@map("pharmacy_branches")
}

model Medicine {
  medicineId       String      @id @default(cuid()) @map("medicine_id")
  medicineName     String      @map("medicine_name") @db.VarChar(50)
  medicineType     MedicineType @map("medicine_type")
  medicineQuantity Int         @map("medicine_quantity")
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  imageUrl         String?     @map("image_url")
  price            Decimal?    @db.Decimal(10, 2)
  orderItems       OrderItem[]
  prescriptionItems PrescriptionItem[]

  @@index([medicineName])
  @@index([medicineType])
  @@map("medicines")
}

model Order {
  orderId         String         @id @default(cuid()) @map("order_id")
  userId          String         @map("user_id")
  prescriptionId  String?        @map("prescription_id")
  totalPrice      Decimal        @default(0) @map("total_price") @db.Decimal(10, 2)
  totalPoints     Int            @default(0) @map("total_points")
  status          String         @default("pending") @db.VarChar(20)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  customerAddress String?        @map("customer_address")
  customerName    String         @map("customer_name") @db.VarChar(255)
  customerPhone   String         @map("customer_phone") @db.VarChar(50)
  items           OrderItem[]
  user            User           @relation(fields: [userId], references: [userId], onDelete: Cascade)
  prescription    Prescription?  @relation(fields: [prescriptionId], references: [prescriptionId])
  branchId        String         @map("branch_id")
  branch          PharmacyBranch @relation(fields: [branchId], references: [branchId])
  paymentMethod   PaymentMethod? @map("payment_method")

  @@index([userId])
  @@index([prescriptionId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  orderItemId        String   @id @default(cuid()) @map("order_item_id")
  orderId            String   @map("order_id")
  medicineId         String   @map("medicine_id")
  prescriptionItemId String?  @map("prescription_item_id")
  quantity           Int
  price              Decimal  @db.Decimal(10, 2)
  medicine           Medicine @relation(fields: [medicineId], references: [medicineId])
  order              Order    @relation(fields: [orderId], references: [orderId], onDelete: Cascade)
  prescriptionItem   PrescriptionItem? @relation(fields: [prescriptionItemId], references: [prescriptionItemId])

  @@index([orderId])
  @@index([medicineId])
  @@index([prescriptionItemId])
  @@map("order_items")
}

model Chat {
  id             Int      @id @default(autoincrement())
  userId         String?
  createdAt      DateTime @default(now())
  summary        Json?
  user           User?    @relation(fields: [userId], references: [userId])
  branchId       String?         @map("branch_id")
  branch         PharmacyBranch? @relation(fields: [branchId], references: [branchId])
  prescriptions  Prescription[]

  @@map("chats")
  @@index([branchId])
}

model Prescription {
  prescriptionId  String   @id @default(cuid()) @map("prescription_id")
  chatId          Int      @map("chat_id")
  userId          String   @map("user_id")
  branchId        String?  @map("branch_id")
  pharmacistId    String?  @map("pharmacist_id")
  status          String   @default("pending") @db.VarChar(20)
  customerName    String   @map("customer_name") @db.VarChar(255)
  customerPhone   String   @map("customer_phone") @db.VarChar(50)
  createdAt       DateTime @default(now()) @map("created_at")
  approvedAt      DateTime? @map("approved_at")
  rejectedAt      DateTime? @map("rejected_at")
  rejectionReason String?  @map("rejection_reason")
  chat            Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user            User     @relation("CustomerPrescriptions", fields: [userId], references: [userId], onDelete: Cascade)
  pharmacist      User?    @relation("PharmacistPrescriptions", fields: [pharmacistId], references: [userId])
  items           PrescriptionItem[]
  orders          Order[]

  @@index([userId])
  @@index([branchId])
  @@index([pharmacistId])
  @@index([status])
  @@index([chatId])
  @@map("prescriptions")
}

model PrescriptionItem {
  prescriptionItemId String   @id @default(cuid()) @map("prescription_item_id")
  prescriptionId     String   @map("prescription_id")
  medicineId         String   @map("medicine_id")
  quantity           Int
  notes              String?
  symptom            String?
  aiRecommendation   String?  @map("ai_recommendation")
  wasRejected        Boolean  @default(false) @map("was_rejected")
  rejectionReason    String?  @map("rejection_reason")
  originalAiRecommendation String? @map("original_ai_recommendation")
  createdAt          DateTime @default(now()) @map("created_at")
  prescription       Prescription @relation(fields: [prescriptionId], references: [prescriptionId], onDelete: Cascade)
  medicine           Medicine @relation(fields: [medicineId], references: [medicineId])
  orderItems         OrderItem[]

  @@index([prescriptionId])
  @@index([medicineId])
  @@map("prescription_items")
}

enum Role {
  ADMIN
  PHARMACIST
  USER
}

enum MedicineType {
  OTC
  NON_OTC
}

enum PaymentMethod {
  CASH
  ONLINE_BANKING
}
